@using Microsoft.AspNetCore.SignalR.Client
@using KingSkullClassicOnline.Client.Shared.Popups
@using KingSkullClassicOnline.Shared
@inherits ComponentBase
@inject IDialogService DialogService

@if (!IsVisible)
{
    return;
}

<PageTitle>Jeu</PageTitle>

<HandGame Cards="Cards" OnCardClick="CardClicked"/>

@code {

    [Parameter]
    public HubConnection Connection { get; set; } = null!;

    [Parameter]
    public ICollection<string> Cards { get; set; } = new List<string>();

    [Parameter]
    public bool IsVisible { get; set; }

    [Parameter]
    public bool IsMyTurn { get; set; }

    private async Task<int> AskVote(int maxVote)
    {
        var options = new DialogOptions { CloseOnEscapeKey = false, CloseButton = false, DisableBackdropClick = true };
        var parameters = new DialogParameters { ["MaxValue"] = maxVote };
        var dialog = DialogService.Show<Vote>("Votez !", parameters, options);
        var result = await dialog.Result;
        return (int)result.Data;
    }

    protected override async Task OnInitializedAsync()
    {
        Connection.On(Events.VoteAsked, async (int _, int maxVote) =>
        {
            var vote = await AskVote(maxVote);
            await Connection.SendAsync(Events.SendVote, vote);
        });
        Connection.On(Events.MustPlay, (IEnumerable<string> playableCards) =>
        {
            Console.WriteLine("Must play with available cards : " + string.Join(", ", playableCards));
            IsMyTurn = true;
        });
    }

    private async void CardClicked(string card)
    {
        await Connection.SendAsync(Events.PlayCard, card);
    }

}